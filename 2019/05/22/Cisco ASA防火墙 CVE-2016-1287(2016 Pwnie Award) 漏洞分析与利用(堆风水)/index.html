<!DOCTYPE html>
<html lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>Cisco ASA防火墙 CVE-2016-1287(2016 Pwnie Award) 漏洞分析与利用(堆风水) | Haoliang.Lu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="前言漏洞描述:Cisco ASA Software处理IKE代码中存在安全漏洞，未经身份验证的远程攻击者发送精心构造的UDP数据包到受影响系统，可造成受影响系统重载或远程执行代码。此漏洞源于受影响代码区域的缓冲区溢出，Cisco官方对该漏洞评级为Critical该漏洞别评为Pwn Awards 2016,Pwnie for Best Server-Side Bug。本文将对该漏洞进行分析，并介绍利">
<meta name="keywords" content="IoT Security">
<meta property="og:type" content="article">
<meta property="og:title" content="Cisco ASA防火墙 CVE-2016-1287(2016 Pwnie Award) 漏洞分析与利用(堆风水)">
<meta property="og:url" content="http://yoursite.com/2019/05/22/Cisco ASA防火墙 CVE-2016-1287(2016 Pwnie Award) 漏洞分析与利用(堆风水)/index.html">
<meta property="og:site_name" content="Haoliang.Lu">
<meta property="og:description" content="前言漏洞描述:Cisco ASA Software处理IKE代码中存在安全漏洞，未经身份验证的远程攻击者发送精心构造的UDP数据包到受影响系统，可造成受影响系统重载或远程执行代码。此漏洞源于受影响代码区域的缓冲区溢出，Cisco官方对该漏洞评级为Critical该漏洞别评为Pwn Awards 2016,Pwnie for Best Server-Side Bug。本文将对该漏洞进行分析，并介绍利">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://yoursite.com/2019/05/22/Cisco%20ASA防火墙%20CVE-2016-1287(2016%20Pwnie%20Award)%20漏洞分析与利用(堆风水)/09B65FE0-58AE-416D-B213-DA10BD4882F8.png">
<meta property="og:image" content="http://yoursite.com/2019/05/22/Cisco%20ASA防火墙%20CVE-2016-1287(2016%20Pwnie%20Award)%20漏洞分析与利用(堆风水)/8A67A2E6-E28C-4A98-AEAE-8FDE243BDDD9.png">
<meta property="og:image" content="http://yoursite.com/2019/05/22/Cisco%20ASA防火墙%20CVE-2016-1287(2016%20Pwnie%20Award)%20漏洞分析与利用(堆风水)/74F50549-45D4-43C1-BE61-36A23CF1A521.png">
<meta property="og:image" content="http://yoursite.com/2019/05/22/Cisco%20ASA防火墙%20CVE-2016-1287(2016%20Pwnie%20Award)%20漏洞分析与利用(堆风水)/F510AC06-97E4-4C6D-9640-1B940463BC82.png">
<meta property="og:image" content="http://yoursite.com/2019/05/22/Cisco%20ASA防火墙%20CVE-2016-1287(2016%20Pwnie%20Award)%20漏洞分析与利用(堆风水)/2348A20C-C51B-442E-A219-B5701E05397B.png">
<meta property="og:image" content="http://yoursite.com/2019/05/22/Cisco%20ASA防火墙%20CVE-2016-1287(2016%20Pwnie%20Award)%20漏洞分析与利用(堆风水)/D1789A80-5FB7-40DF-8D3D-0FC2DF4B3873.png">
<meta property="og:image" content="http://yoursite.com/2019/05/22/Cisco%20ASA防火墙%20CVE-2016-1287(2016%20Pwnie%20Award)%20漏洞分析与利用(堆风水)/DB57DEA5-1834-4B8C-A9AF-3B5559CEBE7D.png">
<meta property="og:image" content="http://yoursite.com/2019/05/22/Cisco%20ASA防火墙%20CVE-2016-1287(2016%20Pwnie%20Award)%20漏洞分析与利用(堆风水)/B1C22548-2B8C-49D5-AD06-1D55C6FC0F0E.png">
<meta property="og:image" content="http://yoursite.com/2019/05/22/Cisco%20ASA防火墙%20CVE-2016-1287(2016%20Pwnie%20Award)%20漏洞分析与利用(堆风水)/0551967E-B41F-4320-B808-CD120AD83A6E.png">
<meta property="og:image" content="http://yoursite.com/2019/05/22/Cisco%20ASA防火墙%20CVE-2016-1287(2016%20Pwnie%20Award)%20漏洞分析与利用(堆风水)/4A7D9E4E-66DA-4BA7-B34B-CCE33B44CE29.png">
<meta property="og:image" content="http://yoursite.com/2019/05/22/Cisco%20ASA防火墙%20CVE-2016-1287(2016%20Pwnie%20Award)%20漏洞分析与利用(堆风水)/4F68BA33-5882-4B8E-B87F-3C3E4560F793.png">
<meta property="og:image" content="http://yoursite.com/2019/05/22/Cisco%20ASA防火墙%20CVE-2016-1287(2016%20Pwnie%20Award)%20漏洞分析与利用(堆风水)/282F2145-83F1-4655-81CF-281ED9125EB1.png">
<meta property="og:image" content="http://yoursite.com/2019/05/22/Cisco%20ASA防火墙%20CVE-2016-1287(2016%20Pwnie%20Award)%20漏洞分析与利用(堆风水)/3C3455F5-ABA0-4F72-8D0A-62C338A4A1A0.png">
<meta property="og:image" content="http://yoursite.com/2019/05/22/Cisco%20ASA防火墙%20CVE-2016-1287(2016%20Pwnie%20Award)%20漏洞分析与利用(堆风水)/C39C1989-D1D4-462F-957F-817A272E812B.png">
<meta property="og:image" content="http://yoursite.com/2019/05/22/Cisco%20ASA防火墙%20CVE-2016-1287(2016%20Pwnie%20Award)%20漏洞分析与利用(堆风水)/0A156A31-FC48-4935-8089-3168181E9A32.png">
<meta property="og:image" content="http://yoursite.com/2019/05/22/Cisco%20ASA防火墙%20CVE-2016-1287(2016%20Pwnie%20Award)%20漏洞分析与利用(堆风水)/C932F1BC-A567-4798-A10D-DEBD872E9ECA.png">
<meta property="og:image" content="http://yoursite.com/2019/05/22/Cisco%20ASA防火墙%20CVE-2016-1287(2016%20Pwnie%20Award)%20漏洞分析与利用(堆风水)/1E741971-BA91-4ED2-B826-42C98419EE56.png">
<meta property="og:image" content="http://yoursite.com/2019/05/22/Cisco%20ASA防火墙%20CVE-2016-1287(2016%20Pwnie%20Award)%20漏洞分析与利用(堆风水)/B10FD02D-78BF-47C6-8CD5-0E2431932355.png">
<meta property="og:image" content="http://yoursite.com/2019/05/22/Cisco%20ASA防火墙%20CVE-2016-1287(2016%20Pwnie%20Award)%20漏洞分析与利用(堆风水)/E5C2889B-AC84-4350-90DC-A727EF5EEEC1.png">
<meta property="og:image" content="http://yoursite.com/2019/05/22/Cisco%20ASA防火墙%20CVE-2016-1287(2016%20Pwnie%20Award)%20漏洞分析与利用(堆风水)/9235EE4C-ABF7-42FB-ACAE-1D19B6A76218.png">
<meta property="og:image" content="http://yoursite.com/2019/05/22/Cisco%20ASA防火墙%20CVE-2016-1287(2016%20Pwnie%20Award)%20漏洞分析与利用(堆风水)/96BDC4A6-A882-44F3-A06A-78506EBD35AD.png">
<meta property="og:image" content="http://yoursite.com/2019/05/22/Cisco%20ASA防火墙%20CVE-2016-1287(2016%20Pwnie%20Award)%20漏洞分析与利用(堆风水)/D2F88D7A-C363-4599-87DC-74CAC07D65FF.png">
<meta property="og:image" content="http://yoursite.com/2019/05/22/Cisco%20ASA防火墙%20CVE-2016-1287(2016%20Pwnie%20Award)%20漏洞分析与利用(堆风水)/C97E37CA-4BF5-4364-890E-3572B839EA75.png">
<meta property="og:image" content="http://yoursite.com/2019/05/22/Cisco%20ASA防火墙%20CVE-2016-1287(2016%20Pwnie%20Award)%20漏洞分析与利用(堆风水)/E05AA6AB-6DD1-4324-A7F7-B99AFE491489.png">
<meta property="og:image" content="http://yoursite.com/2019/05/22/Cisco%20ASA防火墙%20CVE-2016-1287(2016%20Pwnie%20Award)%20漏洞分析与利用(堆风水)/32B62488-FDD0-428C-8B5F-61BA95E724B0.png">
<meta property="og:image" content="http://yoursite.com/2019/05/22/Cisco%20ASA防火墙%20CVE-2016-1287(2016%20Pwnie%20Award)%20漏洞分析与利用(堆风水)/8C2FFE54-D025-4FC5-96CC-DFAFC99EA246.png">
<meta property="og:image" content="http://yoursite.com/2019/05/22/Cisco%20ASA防火墙%20CVE-2016-1287(2016%20Pwnie%20Award)%20漏洞分析与利用(堆风水)/F9311BEC-91D5-4477-A7DC-B1952FFA901A.png">
<meta property="og:image" content="http://yoursite.com/2019/05/22/Cisco%20ASA防火墙%20CVE-2016-1287(2016%20Pwnie%20Award)%20漏洞分析与利用(堆风水)/629577EC-C073-44F0-A93B-718A55176A23.png">
<meta property="og:image" content="http://yoursite.com/2019/05/22/Cisco%20ASA防火墙%20CVE-2016-1287(2016%20Pwnie%20Award)%20漏洞分析与利用(堆风水)/875899D4-4617-4F4A-B668-16005A853957.png">
<meta property="og:image" content="http://yoursite.com/2019/05/22/Cisco%20ASA防火墙%20CVE-2016-1287(2016%20Pwnie%20Award)%20漏洞分析与利用(堆风水)/3A4BE18B-5753-4747-93F0-FCA6F4E8DAB2.png">
<meta property="og:image" content="http://yoursite.com/2019/05/22/Cisco%20ASA防火墙%20CVE-2016-1287(2016%20Pwnie%20Award)%20漏洞分析与利用(堆风水)/9419C504-35A7-481C-979E-BB006E90BD6F.png">
<meta property="og:image" content="http://yoursite.com/2019/05/22/Cisco%20ASA防火墙%20CVE-2016-1287(2016%20Pwnie%20Award)%20漏洞分析与利用(堆风水)/19050247-09F3-428A-9196-6DE6E9C2E23A.png">
<meta property="og:image" content="http://yoursite.com/2019/05/22/Cisco%20ASA防火墙%20CVE-2016-1287(2016%20Pwnie%20Award)%20漏洞分析与利用(堆风水)/A7F18CBE-A78C-4319-A059-15DF54313F50.png">
<meta property="og:image" content="http://yoursite.com/2019/05/22/Cisco%20ASA防火墙%20CVE-2016-1287(2016%20Pwnie%20Award)%20漏洞分析与利用(堆风水)/1663DD7A-6458-47F6-B5CF-A088B9AAE3C8.png">
<meta property="og:image" content="http://yoursite.com/2019/05/22/Cisco%20ASA防火墙%20CVE-2016-1287(2016%20Pwnie%20Award)%20漏洞分析与利用(堆风水)/F0C94E64-6CB5-4930-8300-2D1428FA85B4.png">
<meta property="og:image" content="http://yoursite.com/2019/05/22/Cisco%20ASA防火墙%20CVE-2016-1287(2016%20Pwnie%20Award)%20漏洞分析与利用(堆风水)/7DFDA1A7-E79A-4606-B09F-FE36096A7D2D.png">
<meta property="og:image" content="http://yoursite.com/2019/05/22/Cisco%20ASA防火墙%20CVE-2016-1287(2016%20Pwnie%20Award)%20漏洞分析与利用(堆风水)/B2EDB32E-B053-4956-AA06-4009027D80D8.png">
<meta property="og:image" content="http://yoursite.com/2019/05/22/Cisco%20ASA防火墙%20CVE-2016-1287(2016%20Pwnie%20Award)%20漏洞分析与利用(堆风水)/724C558F-51A0-4D1E-B514-766C03952A10.png">
<meta property="og:updated_time" content="2019-08-11T09:04:54.032Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Cisco ASA防火墙 CVE-2016-1287(2016 Pwnie Award) 漏洞分析与利用(堆风水)">
<meta name="twitter:description" content="前言漏洞描述:Cisco ASA Software处理IKE代码中存在安全漏洞，未经身份验证的远程攻击者发送精心构造的UDP数据包到受影响系统，可造成受影响系统重载或远程执行代码。此漏洞源于受影响代码区域的缓冲区溢出，Cisco官方对该漏洞评级为Critical该漏洞别评为Pwn Awards 2016,Pwnie for Best Server-Side Bug。本文将对该漏洞进行分析，并介绍利">
<meta name="twitter:image" content="http://yoursite.com/2019/05/22/Cisco%20ASA防火墙%20CVE-2016-1287(2016%20Pwnie%20Award)%20漏洞分析与利用(堆风水)/09B65FE0-58AE-416D-B213-DA10BD4882F8.png">
  
  
    <link rel="icon" href="/favicon.ico">
  
  <link rel="stylesheet" href="/css/typing.css">
  <link rel="stylesheet" href="/css/donate.css">
  
  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css">
  
</head>

  
    
      <body>
    
  
      <div id="container" class="container">
        <article id="post-Cisco ASA防火墙 CVE-2016-1287(2016 Pwnie Award) 漏洞分析与利用(堆风水)" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <header id="header" class="header">
  <nav class="mobile-nav">
    <h1 class="nickname">Haoliang.Lu</h1>
    <ul class="mobile-nav-menu">
      <label for="mobile-menu-toggle"><a>&#9776; Menu</a></label>
      <input type="checkbox" id="mobile-menu-toggle"/>
      <ul class="mobile-nav-link">
        
        <a href="/">Home</a>
        
        <a href="/archives">Archives</a>
        
        <a href="/about">About</a>
        
      </ul>
    </ul>
  </nav>
	
		<nav id="main-nav" class="main-nav nav-left">
	
	
	  <a class="main-nav-link" href="/">Home</a>
	
	  <a class="main-nav-link" href="/archives">Archives</a>
	
	  <a class="main-nav-link" href="/about">About</a>
	
  </nav>
</header>

  <hr/>
  <div class="article-inner">
    

    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      Cisco ASA防火墙 CVE-2016-1287(2016 Pwnie Award) 漏洞分析与利用(堆风水)
    </h1>
  

      </header>
    
    <div class="e-content article-entry typo" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>漏洞描述:Cisco ASA Software处理IKE代码中存在安全漏洞，未经身份验证的远程攻击者发送精心构造的UDP数据包到受影响系统，可造成受影响系统重载或远程执行代码。此漏洞源于受影响代码区域的缓冲区溢出，Cisco官方对该漏洞评级为<a href="https://tools.cisco.com/security/center/content/CiscoSecurityAdvisory/cisco-sa-20160210-asa-ike" target="_blank" rel="noopener">Critical</a><br>该漏洞别评为Pwn Awards 2016,Pwnie for Best Server-Side Bug。本文将对该漏洞进行分析，并介绍利用该漏洞借助堆风水技术实现远程任意代码执行。</p>
<h3 id="IKE协议简介"><a href="#IKE协议简介" class="headerlink" title="IKE协议简介"></a>IKE协议简介</h3><p>IKE/IPSec 属于网络层安全协议，保护 IP 及上层的协议安全。从密码学角度看，IKE 用于密钥交换，IPSec 用于保护后续的通信。而保护通信的密钥，就来自 IKE 协议运行的结果。（在 SSL/TLS 协议中，密钥生成和加密保护都是在单独一个协议中完成的，在这一点上，两者各有千秋）</p>
<p>IPSec协议族：</p>
<ul>
<li>AH（Authentication Header）：网络认证头部协议，主要用于数据源验证、数据完整性校验和防报文重放功能。</li>
<li>ESP（Encapsulating Security Payload）：封装安全有效负荷，同样是一个安全协议，与 AH 类似，但是除了 AH 拥有的功能之外还有数据包的加密功能，在 IPSec 中可以使用 AH 或者 ESP 或者两者一起使用。</li>
<li>IKE（Internet Key Exchange）：密钥管理协议，在加密过程会涉及的共享密钥，公钥，私钥等等，所以需要一个专门管理的协议。 IKE（Internet key exchange）：Internet密钥交换协议，属于混合协议，由Internet安全关联和密钥管理协议（ISAKMP）和两种密钥交换协议OAKLEY与SKEME组成。ISAKMP(Internet Security Association and Key Management Protocol)：网络安全联盟的密钥管理协议，这是 IKE 协议中的一部分，AH 与 ESP 的使用时都需要该协议的支持。</li>
</ul>
<p>在IKE协议过程中，提供了一个可选的分片功能，IKE分片是将一个较大的数据包分割成多个较小的碎片发送，碎片的详细结构如下图所示：</p>
<p><img src="09B65FE0-58AE-416D-B213-DA10BD4882F8.png" alt></p>
<p>每一个碎片都属于IKE的载荷，其前面必须是IKE报文头，IKE头部中的载荷类型字段应设置为碎片载荷类型值0x84。对于每个碎片头部中Next_Payload和RESERVED字段必须设置为0，同一组碎片Fragment_ID字段必须设为相同的值，Fragment_Number字段自第一个碎片设置为1开始逐个递增，Flags属于结束标识位，只在最后一个碎片中设置。</p>
<h4 id="IKEv2-协议小记"><a href="#IKEv2-协议小记" class="headerlink" title="IKEv2 协议小记"></a>IKEv2 协议小记</h4><p>鉴于IKE是IPsec的唯一部分仍未经过身份验证和未加密的，它从安全角度引入了特别的兴趣，因为它构成了IPsec的极少数攻击面之一。</p>
<ul>
<li>IKE SA Init</li>
</ul>
<p><img src="8A67A2E6-E28C-4A98-AEAE-8FDE243BDDD9.png" alt></p>
<p><img src="74F50549-45D4-43C1-BE61-36A23CF1A521.png" alt></p>
<ul>
<li>Cisco IKE fragment header</li>
</ul>
<p><img src="F510AC06-97E4-4C6D-9640-1B940463BC82.png" alt></p>
<p><img src="2348A20C-C51B-442E-A219-B5701E05397B.png" alt></p>
<p>tips:如果为最后一个分片，frag last会被置为1</p>
<h3 id="ASA-lina分析"><a href="#ASA-lina分析" class="headerlink" title="ASA lina分析"></a>ASA lina分析</h3><p>因为lina没有符号表等信息，所以通过调试器或推理猜测对binary逻辑进行分析。</p>
<p><img src="D1789A80-5FB7-40DF-8D3D-0FC2DF4B3873.png" alt></p>
<h3 id="lina处理fragment流程分析"><a href="#lina处理fragment流程分析" class="headerlink" title="lina处理fragment流程分析"></a>lina处理fragment流程分析</h3><p>每个fragment均会经过ikev2_add_rcv_frag()和ikev2_reassemble_pkt()两个函数处理，ikev2_add_rcv_frag()负责解析fragment并维护重组队列，ikev2_reassemble_pkt()检查队列和重组，当所有fragment即last fragment字段被设置的帧的sequence number和队列里帧的数量相同，ikev2_reassemble_pkt()才会进行重组。</p>
<p>fragment的size和sequence字段必须为合法值</p>
<p>同一fradment id在同一个queue，同一队列的所有帧大小相同，除了最后一个帧</p>
<p>避免 Negative Copy</p>
<p>1.收到不同于之前fragment id的帧，之前的帧队列将被清空，但size仍保留在<br>2.seq 0的数据不会被重组，因为从1开始重组，但长度会被计算到总长度<br>3.多个带last fragment bit会被添加到重组队列<br>4.有gap的序号不会被重组，但长度会被计算到总长度，如 1，2，4则4不会被重组</p>
<p>发送如下fragment</p>
<ul>
<li>Fragment with ID Y, last fragment bit not set, and size N is sent to set the previous size even though this fragment will be cleared from the queue</li>
<li>Fragment with ID Z, sequence number 0, size 1, and last fragment bit set is sent to clear previous fragment</li>
<li>Fragment with ID Z, sequence number 3, size 1, and last fragment bit set</li>
<li>Fragment with ID Z, sequence number 1, size N, and the last fragment bit clear is sent</li>
</ul>
<p>0和3不会被重组，但两个-7的长度会被加到queue长度总和中，1是唯一一个会被重组的fragment。第一个id Y帧的目的是使之前的queue清空，且把size N留给seq 1使用。</p>
<h4 id="mempool-headers"><a href="#mempool-headers" class="headerlink" title="mempool headers"></a>mempool headers</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">struct mp_header &#123;</span><br><span class="line">    unsigned            mh_magic;</span><br><span class="line">    unsigned            mh_len;</span><br><span class="line">    unsigned            mh_refcount; // also used for free magic when freed</span><br><span class="line">    unsigned            mh_unused;</span><br><span class="line">    struct mp_header *  mh_fd_link;</span><br><span class="line">    struct mp_header *  mh_bk_link;</span><br><span class="line">    void *              alloc_pc;</span><br><span class="line">    void *              free_pc;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>漏洞发生在ASA系统出了IKE密钥交换的代码中，漏洞是由于缓冲区边界检测不严而造成了堆溢出。</p>
<p>当接收到IKE碎片报文，将会触发两个关键的函数， ikev2_add_rcv_frag()和ikev2_reassemble_pkt()。其中第一个函数作用是把接收到每一个碎片添加到重组队列中，第二个函数在所有碎片接收完成后将其重组为一个完整的报文。</p>
<p><img src="DB57DEA5-1834-4B8C-A9AF-3B5559CEBE7D.png" alt></p>
<p>在新收到一个新的碎片后，ikev2_add_rcv_frag()函数都会重新计算重组后的报文长度。下列摘选了ikev2_add_rcv_frag()函数的相关代码片段：</p>
<p><img src="B1C22548-2B8C-49D5-AD06-1D55C6FC0F0E.png" alt></p>
<p>当所有的碎片接收完成后，ikev2_reassemble_pkt()函数将会在内存中申请一块连续的空间存放重组后的报文，相关代码如下：</p>
<p><img src="0551967E-B41F-4320-B808-CD120AD83A6E.png" alt></p>
<p><img src="4A7D9E4E-66DA-4BA7-B34B-CCE33B44CE29.png" alt></p>
<p>在ikev2_add_rcv_frag()函数中存在着逻辑问题，对于每一个接收到的碎片，虽然代码检查了长度的最大值，但却没有检查最小值，并且在每接收到一个碎片后，都会减去它的头部长度8字节，若攻击者构造一组分片包，但其中一个碎片不包含数据段，并将Payload_Length字段设置为小于头部长度的8字节的值，那么存在漏洞的设备在接收到这组分片后，会错误的计算重组队列长度，使得重组队列的长度小于实际接收碎片的总长度，那么在ikev2_reassemble_pkt()函数的内存复制阶段就会发生堆溢出错误。</p>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>如下session2 发送的payload只有seqno 1能被正常重组,利用seqno 1的内容去溢出相邻chunk head的size值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">n = <span class="number">0xd6</span></span><br><span class="line"><span class="comment"># make_cisco_fragment(flength, seqno, fragid, lastfrag, sploit)</span></span><br><span class="line"><span class="comment"># 为了保留长度</span></span><br><span class="line">sess2.send_fragment(<span class="number">0x8</span> + n + <span class="number">3</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="string">"A"</span> * (n + <span class="number">3</span>))</span><br><span class="line">sess2.send_fragment(<span class="number">8</span> + <span class="number">-7</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">1</span>, <span class="string">"B"</span> * (<span class="number">256</span> - <span class="number">7</span>))</span><br><span class="line"><span class="comment"># This fragment will be the one being copied</span></span><br><span class="line"><span class="comment"># during the memory corruption</span></span><br><span class="line">buf = <span class="string">"C"</span> * (n - <span class="number">0xd</span> + <span class="number">0x3</span>)</span><br><span class="line">buf += struct.pack(<span class="string">"&lt;I"</span>, <span class="number">0xef000000</span>)</span><br><span class="line">buf += struct.pack(<span class="string">"&lt;I"</span>, <span class="number">0x00a11ccd</span>) <span class="comment"># chunk magics</span></span><br><span class="line">buf += struct.pack(<span class="string">"&lt;I"</span>, <span class="number">0xe100d4d0</span>)</span><br><span class="line">buf += struct.pack(<span class="string">"B"</span>, <span class="number">0x61</span>)       <span class="comment"># set size from 0x31 to 0x61 in order to encompass the</span></span><br><span class="line">                                    <span class="comment"># adjacent chunk on free</span></span><br><span class="line">sess2.send_fragment(<span class="number">8</span> + n + <span class="number">3</span>, <span class="number">1</span>, <span class="number">6</span>, <span class="number">0</span>, buf)</span><br></pre></td></tr></table></figure>

<p>重组时malloc的长度为 0xe1 - 0x7 - 0x7 = 0xd3(0xe1 = 0xd9 + 8)</p>
<p>我们在0x08767b31处下断点</p>
<p><img src="4F68BA33-5882-4B8E-B87F-3C3E4560F793.png" alt></p>
<p>确认malloc长度为0xd3</p>
<p><img src="282F2145-83F1-4655-81CF-281ED9125EB1.png" alt></p>
<p>实际payload长度为0xe1,所以我们可以溢出14个字节</p>
<p>在0x08767b39处下断点</p>
<p><img src="3C3455F5-ABA0-4F72-8D0A-62C338A4A1A0.png" alt></p>
<p>溢出前的chunk状态</p>
<p><img src="C39C1989-D1D4-462F-957F-817A272E812B.png" alt></p>
<p><img src="0A156A31-FC48-4935-8089-3168181E9A32.png" alt></p>
<p>溢出后，实际应该copy 0xd9 - 14 = 0xcb 大小的数据</p>
<p><img src="C932F1BC-A567-4798-A10D-DEBD872E9ECA.png" alt></p>
<p>由于可以溢出14个字节,刚好可以覆盖相邻free chunk的size字段，及由0x31 - &gt; 0x61</p>
<p><img src="1E741971-BA91-4ED2-B826-42C98419EE56.png" alt></p>
<p>这样如果能提前布置好堆的布局，就可以将一个较小的free chunk覆盖为一个较大的free chunk，这样我们就可以控制被覆盖free chunk后边的chunk的meta data，即达到如下的效果</p>
<p><img src="B10FD02D-78BF-47C6-8CD5-0E2431932355.png" alt></p>
<h4 id="堆风水"><a href="#堆风水" class="headerlink" title="堆风水"></a>堆风水</h4><p>为了实现将堆变为我们可预测的样子，接下来利用ikev2_parse_config_payload()函数进行堆风水。</p>
<p>IKEv2 config payload packet各字段如下：</p>
<p><img src="E5C2889B-AC84-4350-90DC-A727EF5EEEC1.png" alt></p>
<p><img src="9235EE4C-ABF7-42FB-ACAE-1D19B6A76218.png" alt></p>
<p>利用堆风水最终可以实现如下布局</p>
<p><img src="96BDC4A6-A882-44F3-A06A-78506EBD35AD.png" alt></p>
<p>发送大量config包的目的是使接下来分配的packet能够连续地挨在一起，即把一些分散混乱的hole填充掉，如下是发送大量config包之后heap的状态,没有0x100左右大小的hole了，如再申请0x100左右大小的包，可能分割新的top chunk，即在连续的地方分配</p>
<p><img src="D2F88D7A-C363-4599-87DC-74CAC07D65FF.png" alt></p>
<p>发送大量config包之后，发送了如下0x100的包</p>
<p><img src="C97E37CA-4BF5-4364-890E-3572B839EA75.png" alt></p>
<p>此处注意，不论发送多大的包， 每次IKEv2守护程序收到数据包时，都会malloc 0x100字节来处理数据包数据，如果数据大于0x100则释放掉再申请更大的chunk。</p>
<p>此时堆布局如下</p>
<p><img src="E05AA6AB-6DD1-4324-A7F7-B99AFE491489.png" alt></p>
<p>然后通过add_recv_frag，刚刚发送的包（即攻击者可控的包）会排布在该chunk之后，如下图</p>
<p><img src="32B62488-FDD0-428C-8B5F-61BA95E724B0.png" alt></p>
<p>之后第一次申请的0x100的chunk会被释放掉，这样在攻击者可控</p>
<p>之后第一次申请的0x100的chunk会被释放掉，这样在攻击者可控的chunk之前就留下了一个hole。</p>
<p>之后发送如下payload</p>
<p><img src="8C2FFE54-D025-4FC5-96CC-DFAFC99EA246.png" alt></p>
<p>首先IKEv2守护程序收到数据包时，仍会malloc 0x100字节来处理数据包数据，但该包有效大小大于0x100，于是free掉该chunk，malloc一个更大的chunk，如下所示</p>
<p><img src="F9311BEC-91D5-4477-A7DC-B1952FFA901A.png" alt><br>这样0x100的hole又空出来了</p>
<p>ikev2_get_assembled_pkt()函数将分配0xd3大小的块，返回0xd0,（额外的3字节放在footer空着的地方）。由于之前通过config包，将堆中的碎片都去掉了，所有会切割这个0x100的hole，拆分为0xd0和0x30,如下所示</p>
<p><img src="629577EC-C073-44F0-A93B-718A55176A23.png" alt></p>
<p><img src="875899D4-4617-4F4A-B668-16005A853957.png" alt></p>
<p>接着会溢出到0x31 chunk的头部，如下</p>
<p><img src="3A4BE18B-5753-4747-93F0-FCA6F4E8DAB2.png" alt></p>
<p>由于0x31被覆盖成了0x61，刚好包含了相邻的攻击者可以控制chunk的header，于是我们可以在攻击者可控的data部分伪造一个fake chunk header</p>
<p><img src="9419C504-35A7-481C-979E-BB006E90BD6F.png" alt></p>
<p>ikev2_get_assembled_pkt()函数由于收到了 seqno 为3 且为last frag的fragment，但未收到 seqno 2，则会退出循环复制，并且free掉之前的0xd0 chunk，该chunk会前后寻找相邻的free chunk进行合并。此时会和刚刚伪造的0x60进行合并,合并为0x130的free chunk，这样我们便可以重新申请回该free chunk，并覆写其中的多个指针。</p>
<h4 id="劫持控制流"><a href="#劫持控制流" class="headerlink" title="劫持控制流"></a>劫持控制流</h4><p>因为没有safe unlink机制，所有可以利用write4 primitive 劫持控制流。</p>
<p>接下来发送多个0x130的config 包来重新malloc该chunk，进而覆盖多个个指针。之后再出利用在释放堆块的时候触发2次write 4，第一次是130h这个堆块被释放，因为这个堆块开始的时候存放的就是一个分片的数据，之后堆块头被改后，一直没有被释放，直到重新构造出头部后，再次收到新的攻击数据包后，最终释放，第二次是30h和130h合并是产生的，劫持ikev2_add_rcv_frag（）中使用的函数指针到一个固定的地址(即0xc8002000)，跳转到最后一个数据包中的shellcode。<br>tips:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">之所以要找一个可读可写的地址，是因为write4 需要的两个地址均是可读可写，这就意味着不能利用text段的gadget。</span><br></pre></td></tr></table></figure>

<p>分别覆盖0x30 free chunk中的freed fd、bk 和 0x100中的 allocated fd 与 bk。具体如下：</p>
<p><img src="19050247-09F3-428A-9196-6DE6E9C2E23A.png" alt></p>
<p>触发顺序为先触发蓝色，后触发红色。</p>
<p>首先将list_add的函数指针(即ikev2_add_rcv_frag（）中使用的函数指针)改为一个可读可写的内存地址(即0xc8002000)<br><img src="A7F18CBE-A78C-4319-A059-15DF54313F50.png" alt></p>
<p>之所以where处减0x10，原因看allocated chunk的结构(即前文所述mempool的header)</p>
<p><img src="1663DD7A-6458-47F6-B5CF-A088B9AAE3C8.png" alt></p>
<p><img src="F0C94E64-6CB5-4930-8300-2D1428FA85B4.png" alt></p>
<p><img src="7DFDA1A7-E79A-4606-B09F-FE36096A7D2D.png" alt></p>
<p>然后在可读可写的内存地址(即0xc8002000)写入0xc821ff90，反汇编为如下内容</p>
<p><img src="B2EDB32E-B053-4956-AA06-4009027D80D8.png" alt></p>
<p><img src="724C558F-51A0-4D1E-B514-766C03952A10.png" alt></p>
<p>因为ECX寄存器保存一个指向新收到包的data部分，所以 jmp dword ptr [ecx]，可以将控制流劫持到我们的shellcode上。</p>
<h4 id="触发时机"><a href="#触发时机" class="headerlink" title="触发时机"></a>触发时机</h4><p>第一次是130h这个堆块被释放，因为这个堆块开始的时候存放的就是一个分片的数据，之后堆块头被修后，一直没有被释放，直到重新构造出头部后，发送一个不同于之前size的frag，该chunk即可被释放，释放前首先从allocated bin上解链下来，即触发第一个write 4,将list_add的函数指针(即ikev2_add_rcv_frag（）中使用的函数指针)改为一个可读可写的内存地址(即0xc8002000)。0x130这个变为free chunk后，会和相邻的0x30 free chunk进行合并，此时触发第二次 write4,在可读可写的内存地址(即0xc8002000)写入0xc821ff90(jmp dword ptr [ecx])。</p>
<h3 id="后续清理"><a href="#后续清理" class="headerlink" title="后续清理"></a>后续清理</h3><p>因为检测到heap crash后，cisco设备会重启。所以劫持控制流后的shellcode分别修复list_add的指针和corrupted chunk。</p>
<p>清理后利用一个反向shell的shellcode来接管设备。</p>

      
      
    </div>
    <footer class="article-footer">
      <ul class="article-meta">
        <li>
          <span class="label">Published Date:</span>
          <a href="/2019/05/22/Cisco ASA防火墙 CVE-2016-1287(2016 Pwnie Award) 漏洞分析与利用(堆风水)/" class="article-date">
  <time class="dt-published" datetime="2019-05-21T16:00:00.000Z" itemprop="datePublished">2019-05-22</time>
</a>

        </li>
        
        
          <li>
            <span class="label">Tag:</span>
            
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/IoT-Security/">IoT Security</a></li></ul>


          </li>
        
        <hr/>
      </ul>
    </footer>
  </div>
  
    
<nav id="article-nav" class="article-nav">
  
    <span id="article-nav-newer" class="article-nav-link-wrap newer"></span>
  
  
    <a href="/2018/10/29/论文阅读：Peek-a-Boo：I see your smart home activities, even encrypted/" id="article-nav-older" class="article-nav-link-wrap older">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Peek-a-Boo：I see your smart home activities, even encrypted(论文阅读)</div>
    </a>
  
</nav>


  
</article>










      </div>
      
    <footer id="footer" class="post-footer footer">
      
      <hr/>
      <div id="footerContent" class="footer-content">
        <p>The quieter you become,the more you are able to hear.</p>


      </div>
    </footer>

      







<script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>


  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>


<script src="/js/typing.js"></script>
<!--[if lt IE 9]><script src="https://cdn.jsdelivr.net/npm/html5shiv@3/dist/html5shiv.min.js"></script><![endif]-->







    </div>
  </body>
</html>
